<header class="site-header" role="banner">
  <nav class="nav" role="navigation" aria-label="Main">
    <a class="nav__brand" href="{{ '/' | relative_url }}">{{ site.title }}</a>

    <button class="nav__toggle" type="button"
            aria-label="Open menu"
            aria-controls="primary-nav"
            aria-expanded="false">
      <span aria-hidden="true" class="nav__icon"></span>
    </button>

    <ul id="primary-nav" class="nav__links" hidden>
      {% comment %}
      Render links from site.nav with active-state.
      {% endcomment %}
      {% for item in site.nav %}
        {% assign is_active = page.url == item.url or page.url == item.url | append: '/' %}
        <li>
          <a href="{{ item.url | relative_url }}"
             {% if is_active %}aria-current="page" class="is-active"{% endif %}>
            {{ item.text }}
          </a>
        </li>
      {% endfor %}

      {% comment %}
      Ensure "Neurodivergent Lens" appears even if not in site.nav.
      {% endcomment %}
      {% assign lens_matches = site.nav | where: 'url', '/neurodivergent-lens' | size %}
      {% if lens_matches == 0 %}
        {% assign lens_active = page.url == '/neurodivergent-lens' or page.url == '/neurodivergent-lens/' %}
        <li>
          <a href="{{ '/neurodivergent-lens' | relative_url }}"
             {% if lens_active %}aria-current="page" class="is-active"{% endif %}>
            Neurodivergent Lens
          </a>
        </li>
      {% endif %}
    </ul>
  </nav>
</header>

<script>
  (function () {
    const headerEl = document.currentScript.previousElementSibling; // <header>
    const btn = headerEl.querySelector('.nav__toggle');
    const list = headerEl.querySelector('#primary-nav');
    if (!btn || !list) return;

    function toggle(open) {
      btn.setAttribute('aria-expanded', open);
      btn.setAttribute('aria-label', open ? 'Close menu' : 'Open menu');
      if (open) list.removeAttribute('hidden'); else list.setAttribute('hidden', '');
    }

    btn.addEventListener('click', () => {
      const open = btn.getAttribute('aria-expanded') !== 'true';
      toggle(open);
    });

    // Close on Escape & when a link is chosen (mobile UX)
    list.addEventListener('click', e => { if (e.target.tagName === 'A') toggle(false); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') toggle(false); });
  })();
</script>
